# 1. 상황
이제 막 성장 하기 시작한 모바일 앱 푸시 알림 시스템 이며 현재 시스템은 매우 단순한 구조를 가지고 있습니다.

* 알림 생성 요청은 하루 평균 5백만 건에 도달 할 것으로 예상 됩니다.  
* 사용자 액션이 발생 시 서비스 API 서버가 직접 제3자 푸시 서비스(APNS 또는 FCM)에 동기적(synchronous)으로 알림 전송을 요청합니다 (이 설계는 단일 실패 지점(SPOF)이 될 수 있습니다).  
* 최근 사용자가 늘어나면서 푸시 서비스 업체와의 통신 지연이 발생할 때마다, 사용자 요청을 처리하는 API 서버 전체가 느려지는(blocking) 현상이 발생했습니다. 이로 인해 사용자 경험이 저하되고 있습니다.

---

# 2. 문제
위의 API 서버 병목 현상(bottleneck) 문제를 해결하고, 알림 시스템의 확장성과 안정성을 확보하기 위한 개선 방안을 제시해 주세요

![img1.png](img%2Fimg1.png)

## 3. 개선 아키텍처 요약

![img2.png](img%2Fimg2.png)

새로운 아키텍처는 다음과 같은 구성요소로 이루어집니다.

- **서비스**  
  사용자의 특정 액션(예: 메시지 전송, 결제 완료 등)에 따라 알림 요청을 발생시키는 주체입니다.

- **알림 시스템**  
  알림 요청을 수신하여 사용자 정보 및 단말 정보를 **캐시(Cache)** 또는 **데이터베이스(DB)** 에서 조회하고,  
  필요한 알림 데이터를 가공하여 **메시지 큐(Message Queue)** 에 비동기 전송합니다.

- **캐시**  
  변경이 적은 데이터를 빠르게 접근하기 위해 사용됩니다.  
  예: 사용자 정보, 단말 정보, 알림 템플릿 등.

- **데이터베이스(Database)**  
  사용자 정보, 단말 정보, 알림 설정 등의 영구 저장소 역할을 수행합니다.

- **데이터베이스(OutBox)**  
  메시지를 큐에 넣기 직전에 장애가 발생하면 알림이 유실될 수 있습니다.
  이를 방지하기 위해, 알림 시스템은 먼저 Outbox 테이블에 메시지를 INSERT하고,
  Kafka Connect를 통해 해당 데이터를 메시지 큐로 안전하게 적재합니다. 

- **메시지 큐(Kafka)**  
  알림 요청을 비동기적으로 처리하기 위한 구성 요소입니다.  
  제3자 푸시 서비스별로 큐를 분리하여 트래픽 집중 시에도 **확장성(Scalability)** 을 보장합니다.  
  또한 전송 실패 시 **재시도** 로직과 **전송 실패 전용 큐** 를 통해 안정성을 확보합니다.

- **작업 서버**  
  큐에 쌓인 메시지를 소비(consume)하여 실제 푸시 알림을 전송하는 역할을 담당합니다.  
  캐시에서 **알림 템플릿(Notification Template)** 을 조회하여 알림 내용을 구성하고,  
  제3자 서비스(APNS, FCM 등)에 알림을 전송한 뒤 결과를 **알림 로그(Notification Log)** 에 기록합니다.

- **제3자 서비스 (APNS / FCM 등)**  
  실제 사용자 단말로 알림을 전송하는 외부 푸시 서비스입니다.  
  전송 실패 시에는 작업 서버가 해당 정보를 감지하여 메시지 큐에 재시도 요청을 보냅니다.

- **단말 (Device)**  
  푸시 알림을 수신하는 최종 사용자 디바이스입니다.  
  사용자의 클릭 이벤트는 **데이터 분석 서비스**로 전송되어 추적됩니다.

- **데이터 분석 서비스**  
  각 노드별 알림 전송 대기량, 큐 현황, 알림 발송 현황, 클릭 이벤트 등을 분석하여 시스템 성능 모니터링 및 통계 정보를 제공합니다.